<template>
    <div>
        <!-- KPI KARTY -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <h4 class="text-gray-500">Celkem audit≈Ø</h4>
                <p class="text-2xl font-bold">{{ kpi.audits_count }}</p>
            </div>

            <div class="bg-green-100 p-4 rounded-lg shadow border-l-4 border-green-500">
                <h4 class="text-gray-700">OK odpovƒõdi</h4>
                <p class="text-2xl font-bold">{{ kpi.ok }}</p>
            </div>

            <div class="bg-red-100 p-4 rounded-lg shadow border-l-4 border-red-500">
                <h4 class="text-gray-700">NOK odpovƒõdi</h4>
                <p class="text-2xl font-bold">{{ kpi.nok }}</p>
            </div>

            <div class="bg-white p-4 rounded-lg shadow">
                <h4 class="text-gray-500">√öspƒõ≈°nost</h4>
                <p class="text-2xl font-bold">{{ kpi.percent_ok }}%</p>
            </div>
        </div>

        <!-- SEKCE: POSLEDN√ç AUDITY -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <h3 class="text-lg font-semibold mb-3">üìù Posledn√≠ audity</h3>

            <table class="min-w-full border rounded-lg overflow-hidden">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-2 text-left">ID</th>
                        <th class="px-4 py-2 text-left">Mƒõs√≠c</th>
                        <th class="px-4 py-2 text-left">Linka</th>
                        <th class="px-4 py-2 text-left">Oblast</th>
                        <th class="px-4 py-2 text-left">Auditor</th>
                        <th class="px-4 py-2 text-left">Stav</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="a in lastAudits" :key="a.id" class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">{{ a.id }}</td>
                        <td class="px-4 py-2">{{ a.month }}</td>
                        <td class="px-4 py-2">{{ a.line }}</td>
                        <td class="px-4 py-2">{{ a.category }}</td>
                        <td class="px-4 py-2">{{ a.auditor }}</td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded text-sm"
                                :class="a.status === 'done' ? 'bg-green-200' : 'bg-yellow-200'">
                                {{ a.status }}
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- GRAF OK vs NOK -->
        <div class="bg-white p-4 rounded-lg shadow mt-6">
            <h3 class="text-lg font-semibold mb-3">üìà OK vs NOK (posledn√≠ch 6 mƒõs√≠c≈Ø)</h3>
            <canvas id="trendChart" class="w-full h-64"></canvas>
        </div>
    </div>
</template>

<script>
    import Chart from "chart.js/auto";
    import api from "../api";

    export default {
        data() {
            return {
                kpi: {
                    audits_count: 0,
                    ok: 0,
                    nok: 0,
                    percent_ok: 0,
                },
                lastAudits: [],
            };
        },

        async mounted() {
            await this.loadKPI();
            await this.loadLastAudits();
            await this.loadTrend();
        },

        methods: {
            async loadKPI() {
                try {
                    const res = await api.get("/dashboard/kpi");
                    this.kpi = res.data;
                } catch {
                    // fallback, pokud endpoint je≈°tƒõ neexistuje
                    this.kpi = {
                        audits_count: 0,
                        ok: 0,
                        nok: 0,
                        percent_ok: 0,
                    };
                }
            },

            async loadLastAudits() {
                try {
                    const res = await api.get("/dashboard/last-audits");
                    this.lastAudits = res.data;
                } catch {
                    this.lastAudits = [];
                }
            },
            //gRAF
            async loadTrend() {
                const res = await api.get("/dashboard/trend");
                const data = res.data;

                const labels = data.map(d => d.month);
                const okData = data.map(d => d.ok);
                const nokData = data.map(d => d.nok);

                new Chart(document.getElementById("trendChart"), {
                    type: "doughnut",
                    data: {
                        labels,
                        datasets: [
                            {
                                label: "OK",
                                data: okData,
                                borderColor: "#22c55e",
                                backgroundColor: "rgba(34,197,94,0.1)",
                                tension: 0.3,
                            },
                            {
                                label: "NOK",
                                data: nokData,
                                borderColor: "#ef4444",
                                backgroundColor: "rgba(239,68,68,0.1)",
                                tension: 0.3,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: "top" },
                        },
                        scales: {
                            y: { beginAtZero: true },
                        },
                    },
                });
            },
        },
    };
</script>


audit
<template>
    <div class="max-w-5xl p-6 mx-auto">
        <h2 class="mb-6 text-2xl font-bold">üìã Proveden√≠ auditu</h2>

        <!-- v√Ωbƒõr p≈ôidƒõlen√≠ -->
        <div v-if="!executionId" class="mb-6">
            <label class="font-semibold">Vyber p≈ôidƒõlen√≠:</label>
            <select v-model="selectedAssignmentId" @change="startAudit" class="px-3 py-2 ml-2 border rounded">
                <option :value="null">-- vyber --</option>
                <option v-for="a in assignments" :key="a.id" :value="a.id">
                    {{ a.line_name }} ‚Äî {{ a.category_name }} ({{ a.status }})
                </option>
            </select>
        </div>

        <!-- prob√≠haj√≠c√≠ audit -->
        <div v-if="executionId">
            <div class="mb-4 text-lg font-semibold">
                {{ assignedCategoryName }} ‚Äî checklist
            </div>

            <table class="w-full text-sm border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="w-16 p-2 border">#</th>
                        <th class="p-2 border">Ot√°zka</th>
                        <th class="w-48 p-2 border">Odpovƒõƒè</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="pos in maxPosition" :key="pos">
                        <td class="p-2 text-center border">{{ pos }}</td>
                        <td class="p-2 border">
                            <span v-if="questionsByPosition[pos]">
                                {{ questionsByPosition[pos].question_text }}
                            </span>
                            <span v-else class="text-gray-400">‚Äî</span>
                        </td>
                        <td class="p-2 text-center border">
                            <div v-if="questionsByPosition[pos]">
                                <button class="px-3 py-1 mr-2 border rounded"
                                    :class="answers[questionsByPosition[pos].id]==='OK' ? 'bg-green-200' : ''"
                                    @click="saveAnswer(questionsByPosition[pos].id,'OK')">
                                    OK
                                </button>
                                <button class="px-3 py-1 border rounded"
                                    :class="answers[questionsByPosition[pos].id]==='NOK' ? 'bg-red-200' : ''"
                                    @click="saveAnswer(questionsByPosition[pos].id,'NOK')">
                                    NOK
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="mt-6">
                <button :disabled="!canFinish" @click="finishAudit"
                    class="px-4 py-2 text-white bg-blue-600 rounded disabled:opacity-40">
                    Ukonƒçit audit
                </button>
            </div>
        </div>

        <!-- NOK modal -->
        <div v-if="nokQuestionId" class="fixed inset-0 flex items-center justify-center bg-black/40">
            <div class="p-6 bg-white rounded shadow w-96">
                <h3 class="mb-3 font-bold">Popis neshody</h3>
                <input type="file" @change="e => nokFile = e.target.files[0]" />
                <textarea v-model="nokComment" class="w-full p-2 mb-3 border"></textarea>
                <div class="text-right">
                    <button class="mr-2" @click="nokQuestionId=null">Zru≈°it</button>
                    <button class="px-3 py-1 text-white bg-red-500 rounded" @click="confirmNok">Ulo≈æit</button>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    import api from '../api'

    export default {
        data() {
            return {
                assignments: [],
                selectedAssignmentId: null,
                executionId: null,
                questionsByPosition: {},
                assignedCategoryName: '',
                maxPosition: 4,
                answers: {},
                nokQuestionId: null,
                nokComment: '',
                nokFile: null
            }
        },

        computed: {
            canFinish() {
                const q = Object.values(this.questionsByPosition)
                return q.length && q.every(x => this.answers[x.id])
            }
        },

        async mounted() {
            await this.loadAssignments()

            const saved = localStorage.getItem("activeExecution");

            if (saved) {
                this.executionId = saved;

                const exec = await api.get(`/executions/${saved}`);
                this.selectedAssignmentId = exec.data.assignment_id;

                await this.loadExecution();
            }
        },


        methods: {
            async loadAssignments() {
                const res = await api.get('/assignments')
                this.assignments = res.data.filter(a => a.status !== 'done')
            },

            async startAudit() {
                if (!this.selectedAssignmentId) return;
                try {
                    // zkus√≠me start
                    const res = await api.post(
                        `/executions/start?assignment_id=${this.selectedAssignmentId}`);
                    this.executionId = res.data.execution_id;
                    localStorage.setItem("activeExecution", this.executionId);
                } catch (err) {
                    // pokud u≈æ existuje ‚Üí backend vrac√≠ 400
                    if (err.response?.status === 400) {

                        // naƒçteme existuj√≠c√≠ execution
                        const existing = await api.get(`/executions/by-assignment/${this.selectedAssignmentId}`);
                        this.executionId = existing.data.execution_id; localStorage.setItem("activeExecution", this.executionId);
                    } else {
                        alert("Nepoda≈ôilo se spustit audit");
                        return;
                    }
                }
                await this.loadExecution();
            },

            async loadExecution() {

                // v≈ædy naƒçti assignment z backendu (jistota)
                const res = await api.get(`/assignments/${this.selectedAssignmentId}`);
                const a = res.data;

                this.assignedCategoryName = a.category_name;

                await this.loadChecklist(a.template_id, a.category_id);
                await this.loadExistingAnswers();
            },

            async loadChecklist(templateId, categoryId) {
                if (!templateId || !categoryId) return;
                const res = await api.get(`/checklist/templates/${templateId}/questions`)
                const byPos = {}
                let max = 0
                res.data.filter(q => q.category_id === categoryId).forEach(q => {
                    byPos[q.position] = q
                    if (q.position > max) max = q.position
                })
                this.questionsByPosition = byPos
                this.maxPosition = Math.max(max, 4)
            },

            async loadExistingAnswers() {
                const res = await api.get(`/answers/execution/${this.executionId}`)
                this.answers = {}
                res.data.forEach(a => this.answers[a.question_id] = a.odpoved)
            },

            async saveAnswer(questionId, val) {
                if (val === 'NOK') {
                    this.nokQuestionId = questionId
                    return
                }
                await this.sendAnswer(questionId, val, null)
            },

            async confirmNok() {
                await this.sendAnswer(this.nokQuestionId, 'NOK', this.nokComment, this.nokFile);
                this.nokQuestionId = null;
                this.nokComment = '';
                this.nokFile
            },

            async sendAnswer(questionId, value, comment = null, file = null) {

                const form = new FormData();
                form.append("audit_execution_id", this.executionId);
                form.append("question_id", questionId);
                form.append("odpoved", value);
                form.append("has_issue", value === "NOK");

                if (comment) form.append("poznamka", comment);
                if (file) form.append("picture", file);

                await api.post("/answers", form, {
                    headers: { "Content-Type": "multipart/form-data" }
                });

                this.answers[questionId] = value;
            },

            async finishAudit() {
                await api.post(`/executions/finish?execution_id=${this.executionId}`)
                localStorage.removeItem('activeExecution')
                this.executionId = null
                this.selectedAssignmentId = null
                this.answers = {}
                await this.loadAssignments()
            }
        }
    }
</script>